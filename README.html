<!DOCTYPE html> 
<html> 
<head> 
	<title>SyLens for Nuke</title> 
	<style type='text/css'> 
body {
  font-family: "Helvetica Neue", Helvetica, "Lucida Sans Unicode", Arial, sans-serif;
  padding: 2em;
  background: rgb(255,255,255);
  color: rgb(10,10,10);
}

h1,h2,h3,h4 {
  font-family: "Lucida Grande", sans-serif;
}

dt {
	font-weight: bold;
}
	</style> 
</head> 
<body> 

  <h1>SyLens for Nuke</h1>
  
  <p>These plugins help to prep images that have been undistorted using the Syntheyes matchmoving software. It implements the same undistortion algorithm
    as the one embedded in Syntheyes and explained <a href="http://www.ssontech.com/content/lensalg.htm">here.</a>
  
  <p>The currently provided plugins are:</p>
	
	<ul>
		<li><a href="#sylens">SyLens for images</a></li>
		<li><a href="#syuv">SyUV for undistortion of projected UVs</a></li>
		<li><a href="#sycam">SyCamera for rendering 3D with distortion baked in</a></li>
	</ul>
	
	<p>To get started right away, have a look at the <tt>sample.nk</tt> test file included with the plugin.</p>
	
	<h2 id="sylens">The SyLens node</h2>
	
	<p>SyLens node works with image inputs.</p>
	<h3>Undistorting footage </h3>

	<p>Punch in the lens distortion into the lens settings panel</p>
	<img src="images/kappa_value.png" width="404" height="109" alt="Kappa Value" />
	<p>or let Syntheyes compute it for you...</p>
	<br />
	<img src="images/auto_disto.png" width="199" height="267" alt="Auto Disto" />
	
	<p id="iop">Then just punch in the computed distortion value into the <tt>k</tt> knob</p>
	
	<img src="images/just_k.png" width="495" alt="Just K" />
	<p>You will probably note that the bounding box of your output will stick outside the format - this is perfectly fine, read below
	how to deal with that</p>

	<h3>Redistorting footage</h3>
	<p>After all is done you might want to redistort either your whole comp or only the piece of CG that came to you from 3D (since it would have been
		rendered from the undistorted film back size). To redistort, plug your oversize plate into a copy of SyLens with the "mode" switch set to
		"redistort". <i>See to it that other settings - k, kcube - stay the same!</i></p>
		
	<h3>Cropping and bounding box</h3>
	<p>The workflow in a nutshell:</p>
	<img src="images/SyLens_Figures_03.png" alt="Cropping workflow" />
	
	<h3>Explanation of the UI controls</h3>
	<dl>
		<dt>mode</dt>
		<dd>When set to <i>undistort</i>, SyLens will remove lens distortion. When set to <i>redistort</i> SyLens will apply lens distortion</dd>

		<dt>k</dt>
		<dd>Quartic distortion coefficient. This is calculated by Syntheyes and needs to be punched in here.</dd>
		
		<dt>kcube</dt>
		<dd>Cubic distortion modifier. If you used this in Syntheyes you can apply it here as well. <b>Note that this will not be reapplied during redistortion</b></dd>
		
		<dt>ushift</dt>
		<dd>Sometimes you are dealing with off-center lens distortion. This can occur when a lens is fitted onto the camera but not properly centered onto the sensor
			(some lens adapters are especially susceptible to this, like the anamorphic Alexa fittings). Apply some margin here to shift your distortion midpoint left or right with regards to the
			center of your digital plate.</dd>
			
		<dt>vshift</dt>
		<dd>Sometimes you are dealing with off-center lens distortion. This can occur when a lens is fitted onto the camera but not properly centered onto the sensor
			(some lens adapters are especially susceptible to this, like the anamorphic Alexa fittings). Apply some margin here to shift your distortion midpoint up or down with regards to the
			center of your digital plate.</dd>
		
		<dt>filter</dt>
		<dd>This selects the filtering algorithm used for sampling the source image, pick one that gives a better-looking result</dd>
		
		<dt>trim bbox</dt>
		<dd>When you apply distortion to the image, the bounding box that SyLens receives will usually grow. For example, when reintroducing distortion,
			there will be overflow outside of the image:
			
			When you are compositing redistorted items onto the source you generally don't want to have this overscan. When you enable <i>trim bbox</i> the
			size of the bounding box will be reduced to fit within the actual output format, and no overscan pixels will be output or computed.</dd>
		
		<dt>debug info</dt>
		<dd>You can see what SyLens is doing. When you enable this, debug info will be written to STDOUT. If you start Nuke from the terminal then this
			terminal will contain all the relevant output.</dd>
		
		<dt>only format</dt>
		<dd>If all you need is knowing the size of the background (for example to use as a background for the ScanlineRender node), but no actual pixels.
			Checking this box will make Syntheyes output the format boxes only, but no computation of pixels will be done and no upstream pixels
			will be requested or copied (and thing will speed up tenfold). When you use this as input for the 3D you can also enable and disable this
			knob to check your alignment with the background.</dd>
	</dl>

	<h3>Standard projection workflow caveats</h3>
	
	<p>SyLens creates images which have overflow bounding box, that is - <b>bounding box that extends outside the image format.</b> For that reason creating a roundtrip
		projection setup needs a little work to get right.</p>
	
	<p>To spare you some grief, here's how your DAG should look:</p>
	
	<img src="images/projection_dag.png" width="896" height="683" alt="Projection Dag" />
	
	<p>I am highlighting the special parameters from the node bin which differ from the defaults.</p>
	

	<p>Important points:</p>
	<ul>
		<li>This relies on using Nuke's "overscan" (bbox that goes outside of the image format). Enable "Show overscan" in the viewer context menu to actually <b>see</b>
			what's in there.</li>
		<li>Project3d will only project the image outside of the format with "crop" checkbox disabled</li>
		<li>You need to render some overscan from your ScanlineRenderer to fill the bbox covered area. By default the renderer only renders within the format</li>
		<li>Use your cameras as usual (do not change the field of view)</li>
	</ul>

	<p>Alternatively, render with a <a href="#sycamera">SyCamera node</a> instead of the standard camera and get even better results if your
		meshes permit it.</p>
		
	<h2 id="syuv">The SyUV node</h2>
	
	<p>The SyUV node is a modifier for the input geometry. It will undistort your image in UV space so that you can preserve filtering steps.<p>
	
	<p>It is built to account for <em>projected UVs</em>.
	
	<h3>Workflow with UV distortion</h3>
	
	<p>Typically you would be using it like this:</p>
	
	<img src="images/syuv_dag.png" alt="SyUV DAG" />
	
	<p>Here we project the UVs from our projection camera.</p>
	
	<p>Make sure that the camera you are projecting UVs from has it's <strong>vertical aperture</strong> set correctly. If you are seeing
	mismatches between your projected UVs and the actual image, this is the culprit.</p>
	
	<p>Afterwards, apply the <em>SyUV</em> node. You can also apply it to a plain Card, or you can
	apply it to an arbitrary mesh - what is important is having the UVs projected from your camera, not the standard UVs or unwraps.</p>
	
	<p>Create the node and dial in the controls just as the <a href="#iop">main SyLens plugin.</a></p>
	
	<p>The undistorted image will look like this in the viewport. <strong>Note that to make efficient use of SyUV your geometry needs to be
		relatively dense</strong> since we can only apply undistortion at the vertices of the image. Everything within one quad/triangle will be
		interpolated in a linear fashion.<p>
		
	<img src="images/syuv_undisto.png" alt="SyUV undistortion in the viewport" />
			
	<h3>Explanation of the UI controls</h3>
	
	<p>The UI controls of SyUV are very similar to the standard SyLens plugin.</p>
	
	<img src="images/syuv_controls.png" alt="SyUV controls in the node bin" />
	
	<dl>
		<dt>k</dt>
		<dd>Quartic distortion coefficient. This is calculated by Syntheyes and needs to be punched in here.</dd>

		<dt>kcube</dt>
		<dd>Cubic distortion modifier. If you used this in Syntheyes you can apply it here as well.</dd>

		<dt>aspect</dt>
		<dd>The Syntheyes algorithm <strong>requires</strong> the aspect ratio of your distorted plate. This cannot be automatically deciphered from the UVs so
			you need to dial it in manually. Use your image's aspect ratio.</dd>
		
		<dt>ushift</dt>
		<dd>Sometimes you are dealing with off-center lens distortion. This can occur when a lens is fitted onto the camera but not properly centered onto the sensor
			(some lens adapters are especially susceptible to this, like the anamorphic Alexa fittings). Apply some margin here to shift your distortion midpoint left or right with regards to the
			center of your digital plate.</dd>

		<dt>vshift</dt>
		<dd>Sometimes you are dealing with off-center lens distortion. This can occur when a lens is fitted onto the camera but not properly centered onto the sensor
			(some lens adapters are especially susceptible to this, like the anamorphic Alexa fittings). Apply some margin here to shift your distortion midpoint up or down with regards to the
			center of your digital plate.</dd>
	
		<dt>uv attrib</dt>
		<dd>Nuke allows for arbitrary UV attributes to be added to the main geometry. If you want to manipulate a non-standard UV channel punch it's name in
			here. Normally you would leave this parameter at it's default setting.</dd>
	</dl>
	
	<h2 id="sycamera">The SyCamera node</h2>
	
	<p>The SyCamera node performs distortion in camera space. You can use it just like you would use a standard Nuke camera node. However, once plugged
	into the render node it will distort the rendered output according to the Syntheyes algorithm.</p>
	
	<p>Here's how a render looks with the standard Nuke camera:</p>
	<img src="images/cam_std.png" width="533" height="410" alt="Cam Std" />
	
	<p>...and here's how it looks rendered with the SyCamera:</p>
	<img src="images/cam_sy.png" width="534" height="420" alt="Cam Sy" />
	
	<p>The only difference with the standard Nuke camera is the addition of the SyLens controls tab. Use it the same way you would be using
	SyLens.</p>
	
	<img src="images/cam_controls.png" width="433" height="141" alt="Cam Controls">
	
	<p>Note that in order to achieve good redistortion you need to have enough vertices in your geometry. For example, a Cylinder having
	only one span vertically only distorts at the caps with straight lines being traced between vertices:</p>
	<img src="images/cam_few_subdivs.png" width="351" height="264" alt="Cam Few Subdivs" />

	<p>..while a well-subdivided Cylinder will distort like this:</p>
	<img src="images/cam_many_subdivs.png" width="356" height="275" alt="Cam Many Subdivs">
	 
	<!-- todo - bbox -->
	<h3>Explanation of the UI controls</h3>
	
	<dl>
		<dt>k</dt>
		<dd>Quartic distortion coefficient. This is calculated by Syntheyes and needs to be punched in here.</dd>

		<dt>kcube</dt>
		<dd>Cubic distortion modifier. If you used this in Syntheyes you can apply it here as well.</dd>

		<dt>aspect</dt>
		<dd>The Syntheyes algorithm <strong>requires</strong> the aspect ratio of your distorted plate. This cannot be automatically deciphered from the Camera node so
			you need to dial it in manually. Use your image's aspect ratio.</dd>
		
		<dt>ushift</dt>
		<dd>Sometimes you are dealing with off-center lens distortion. This can occur when a lens is fitted onto the camera but not properly centered onto the sensor
			(some lens adapters are especially susceptible to this, like the anamorphic Alexa fittings). Apply some margin here to shift your distortion midpoint left or right with regards to the
			center of your digital plate.</dd>
			
		<dt>vshift</dt>
		<dd>Sometimes you are dealing with off-center lens distortion. This can occur when a lens is fitted onto the camera but not properly centered onto the sensor
			(some lens adapters are especially susceptible to this, like the anamorphic Alexa fittings). Apply some margin here to shift your distortion midpoint up or down with regards to the
			center of your digital plate.</dd>

	</dl>
	
	<h2>Building the plugins</h2>
	
	<p>Go to the <tt>src</tt> directory, and there:</p>
	 <code><pre>
make -f Makefile.mac NDKDIR=/Applications/Nuke6.3v1/Nuke6.3v1.app/Contents/MacOS # for MacOS
make -f Makefile.lin NDKDIR=/mnt/server/thefoundry/Nuke6.3v1/Nuke6.3v1 # for Linux
	</pre></code>
	
	<p>The plugins only use some standard containers and the NDK API, so you won't need to compile Boost or other third-party
	libraries.</p>
	
	<h2>Testing the plugins</h2>
		
	<p>See the scripts in the <tt>sample_scripts</tt> directory.</p>
	
	<h2>Credits</h2>
	
	<p>The plugins have been created by Julik Tarkhanov in Amsterdam in 2010, 2011 and 2012. Based on the 3DE distortion plugin by Matti Grüner.<br />
	Special thanks to Dmitry Korshunov for the Windows builds, Jonathan Egstad and Ivan Busquets for their tips and advice and to Marijn Eken for bug reports.
	SyUV and SyCamera have been supported by Elefant Studios, Zürich and Miklos Kozary.</p>
	
	<p>The beautiful landscape shot used in the test scripts has been provided by Tim Parshikov and Mikhail Mestezky and the "Drug Druga" production company.</p>
	
	<h2>Questions and remarks</h2>
	
	<p>For questions and comments shoot a mail to me _at_ julik.nl</p>
	
	<h2>License</h2>
	
	<pre>
	Copyright (c) 2010 Julik Tarkhanov

	Permission is hereby granted, free of charge, to any person obtaining
	a copy of this software and associated documentation files (the
	"Software"), to deal in the Software without restriction, including
	without limitation the rights to use, copy, modify, merge, publish,
	distribute, sublicense, and/or sell copies of the Software, and to
	permit persons to whom the Software is furnished to do so, subject to
	the following conditions:

	The above copyright notice and this permission notice shall be
	included in all copies or substantial portions of the Software.

	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
	EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
	MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
	NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
	LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
	OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
	WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
	</pre>
  </body>
</html>