<!DOCTYPE html> 
<html> 
<head> 
	<title>SyLens for Nuke</title> 
	<style type='text/css'> 
body {
  font-family: "Helvetica Neue", Helvetica, "Lucida Sans Unicode", Arial, sans-serif;
  padding: 2em;
  background: rgb(255,255,255);
  color: rgb(10,10,10);
}

h1,h2,h3,h4 {
  font-family: "Lucida Grande", sans-serif;
}

dt {
	font-weight: bold;
}
	</style> 
</head> 
<body> 

  <h1>SyLens for Nuke</h1>
  
  <p>This plugin helps to prep images that have been undistorted using the Syntheyes matchmoving software. It implements the same undistortion algorithm
    as the one embedded in Syntheyes and explained <a href="http://www.ssontech.com/content/lensalg.htm">here.</a>
  
	<h2>Undistorting footage </h2>

	<h3>Workflow A</h3>
  <p>To use the plugin, you will need to use the Lens Workflow script included with Syntheyes. When you have solved the shot, lens distortion will likely be
    computed. After that, hit "Lens Workflow".</p>
  <img src="doc/lensw.png" width="600" height="430" alt="Lensw">
  <p>You will be presented with a choice dialog, and the option you need is the one called "Redistorted"</p>
  <img src="doc/lenswm2.png" width="750" height="174" alt="Lenswm2">
  <p>What it does is it undistorts your footage, and simultaneously makes your camera FOV a little wider and
    your composition size (the film back) a little bigger, to accomodate for image parts that would disappear
    if you would be undistorting the image by other means.</p>
  <p>Now open the <b>Shot->Image Preparation</b> menu. Go to the Lens tab and note the values for Distortion and Cubic Distort.
    Then note down the crop values on the Cropping tab.<p>
  <p>Load your source footage into Nuke and punch in the values, here's how they are related:</p>
  <img src="doc/alltogether.png" width="861" height="386" alt="Alltogether">
  <p>and you should get exactly the same undistortion as the one you would have gotten from Syntheyes using the Save Sequence button.</p>
  
	<h3>Workflow B</h3>
	
	<p>Alternatively, you can punch in the lens distortion into the solver panel or let Syntheyes compute it for you</p>
	<img src="doc/auto_disto.png" width="199" height="267" alt="Auto Disto" />
	
	<p>Then just punch in the computed distortion value into the <tt>k</tt> knob</p>
	
	<img src="doc/just_k.png" width="495" height="122" alt="Just K" />
	<p>You will probably note that the bounding box of your output will stick outside the format - this is perfectly fine, read below
	how to deal with that</h2>

	<h2>Redistorting footage</h2>
	<p>After all is done you might want to redistort either your whole comp or only the piece of CG that came to you from 3D (since it would have been
		rendered from the undistorted film back size). To redistort, plug your oversize plate into a copy of SyLens with the "mode" switch set to
		"redistort". <i>See to it that other settings - k, kcube and uncrop - stay the same!</i></p>
		
		<h2>Cropping and bounding box</h2>
		<p>The workflow in a nutshell:</p>
		<img src="doc/SyLens_Figures_03.png" alt="Cropping workflow" />
	 <h2>Explanation of the UI controls</h2>
	 <dl>
			<dt>mode</dt>
			<dd>When set to <i>undistort</i>, SyLens will remove lens distortion. When set to <i>redistort</i> SyLens will apply lens distortion</dd>

			<dt>k</dt>
			<dd>Quartic distortion coefficient. This is calculated by Syntheyes and needs to be punched in here.</dd>
			
			<dt>kcube</dt>
			<dd>Cubic distortion modifier. If you used this in Syntheyes you can apply it here as well. <b>Note that this will not be reapplied during redistortion</b></dd>
			
			<dt>uncrop expansion<dt>
			<dd>If you are dealing with pin-cushion distortion, there are parts of the image in the corners that will end up outside of your current
				image format as the corners of the image are pulled outwards. To account for that, Syntheyes will usually add some "crop" values in the
				Image Preparation screen to make your camera field of view a tad larger, and your output format a tad bigger to account for these corners.
				To produce exactly the same image size at the end we need to know this crop value that SynthEyes applies.</dd>
			
			<dt>filter</dt>
			<dd>This selects the filtering algorithm used for sampling the source image, pick one that gives a better-looking result</dd>
			
			<dt>trim bbox</dt>
			<dd>When you apply distortion to the image, the bounding box that SyLens receives will usually grow. For example, when reintroducing distortion,
				there will be overflow outside of the image:
				
				When you are compositing redistorted items onto the source you generally don't want to have this overscan. When you enable <i>trim bbox</i> the
				size of the bounding box will be reduced to fit within the actual output format, and no overscan pixels will be output or computed.</dd>
			
			<dt>debug info</dt>
			<dd>You can see what SyLens is doing. When you enable this, debug info will be written to STDOUT. If you start Nuke from the terminal then this
				terminal will contain all the relevant output.</dd>
			
			<dt>only format</dt>
			<dd>If all you need is knowing the size of the background (for example to use as a background for the ScanlineRender node), but no actual pixels.
				Checking this box will make Syntheyes output the format boxes only, but no computation of pixels will be done and no upstream pixels
				will be requested or copied (and thing will speed up tenfold). When you use this as input for the 3D you can also enable and disable this
				knob to check your alignment with the background.</dd>
		</dl>
	
	<h2>Standard projection workflow caveats</h2>
	
	<p>SyLens creates images which have overflow bounding box, that is - <b>bounding box that extends outside the image format.</b> For that reason creating a roundtrip
		projection setup needs a little work to get right.</p>
	
	<p>To spare you some grief, here's how your DAG should look:</p>
	
	<img src="doc/projection_dag.png" width="896" height="683" alt="Projection Dag" />
	
	<p>I am highlighting the special parameters from the node bin which differ from the defaults.</p>
	
	<p>Important points:</p>
	<ul>
		<li>Project3d will only project the image outside of the format with "crop" checkbox disabled</li>
		<li>You need to render some overscan from your ScanlineRenderer to fill the bbox covered area. By default the renderer only renders within the format</li>
		<li>Use your cameras as usual (do not change the field of view)</li>
	</ul>
		
	<p>
	<p>For questions and comments shoot a mail to me _at_ julik.nl</p>
	
  </body>
</html>